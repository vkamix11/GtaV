<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Mini GTA – Etap 1 (OPTIMIZED)</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: black;
  touch-action: none;
}
canvas { width: 100%; height: 100%; display: block; }
</style>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
<canvas id="game"></canvas>

<script>
/* =============================
   DETEKCJA MOBILE
============================= */
const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);

/* =============================
   SILNIK – OPTYMALIZACJA
============================= */
const canvas = document.getElementById("game");
const engine = new BABYLON.Engine(canvas, true, {
  preserveDrawingBuffer: false,
  stencil: false,
  antialias: false
});

engine.setHardwareScalingLevel(isMobile ? 1.5 : 1);

const scene = new BABYLON.Scene(engine);
scene.skipPointerMovePicking = true;
scene.autoClear = true;
scene.clearColor = new BABYLON.Color3(0.6, 0.8, 1);

/* =============================
   KAMERA
============================= */
const camera = new BABYLON.FreeCamera(
  "cam",
  new BABYLON.Vector3(0, 60, -120),
  scene
);
camera.attachControl(canvas, true);
camera.speed = isMobile ? 1 : 2;

/* =============================
   ŚWIATŁO (1 JEDYNE)
============================= */
const light = new BABYLON.HemisphericLight(
  "light",
  new BABYLON.Vector3(0, 1, 0),
  scene
);
light.intensity = 0.9;

/* =============================
   MATERIAŁY (REUSE)
============================= */
const buildingMat = new BABYLON.StandardMaterial("bmat", scene);
buildingMat.diffuseColor = new BABYLON.Color3(0.6, 0.6, 0.6);

const grassMat = new BABYLON.StandardMaterial("gmat", scene);
grassMat.diffuseColor = new BABYLON.Color3(0.2, 0.6, 0.2);

/* =============================
   PODŁOŻE
============================= */
const ground = BABYLON.MeshBuilder.CreateGround(
  "ground",
  { width: 2000, height: 2000 },
  scene
);
ground.material = grassMat;

/* =============================
   MESH BAZOWY (1x)
============================= */
const baseBuilding = BABYLON.MeshBuilder.CreateBox(
  "baseBuilding",
  { width: 18, depth: 18, height: 1 },
  scene
);
baseBuilding.isVisible = false;
baseBuilding.material = buildingMat;

/* =============================
   GENERATOR MIASTA (INSTANCJE)
============================= */
class CityGenerator {
  constructor(scene) {
    this.scene = scene;
    this.block = 30;
    this.size = isMobile ? 12 : 25;
  }

  generate() {
    for (let x = -this.size; x < this.size; x++) {
      for (let z = -this.size; z < this.size; z++) {
        if (Math.random() < 0.25) continue;

        const h = 10 + Math.random() * 80;
        const b = baseBuilding.createInstance("b");

        b.scaling.y = h;
        b.position.set(
          x * this.block,
          h / 2,
          z * this.block
        );
      }
    }
  }
}

new CityGenerator(scene).generate();

/* =============================
   MOBILE TOUCH (LEKKIE)
============================= */
let lastX, lastY;
canvas.addEventListener("touchmove", e => {
  if (e.touches.length === 1) {
    const t = e.touches[0];
    if (lastX !== undefined) {
      camera.rotation.y += (t.clientX - lastX) * 0.004;
      camera.rotation.x += (t.clientY - lastY) * 0.004;
    }
    lastX = t.clientX;
    lastY = t.clientY;
  }
});

/* =============================
   LOOP
============================= */
engine.runRenderLoop(() => scene.render());
window.addEventListener("resize", () => engine.resize());
</script>
</body>
</html>
